{"pageProps":{"post":{"title":" 分布式事务","comments":true,"date":"2021-02-17T00:00:00.000Z","tags":["分布式"],"categories":["总结"],"modifyTime":"2021-03-27 14:49:15 +0800","createTime":"2021-04-26 11:57:09 +0800","logs":[{"status":["M"],"files":["\"2021-03-27 \\345\\210\\206\\345\\270\\203\\345\\274\\217\\344\\272\\213\\345\\212\\241.md\""],"abbrevHash":"54e4fe7","hash":"54e4fe74979fb3db6a82711a937c75421dc7c2c1","subject":"Update 2021-03-27 分布式事务.md","authorName":"yajw","authorDate":"2021-04-26 11:57:09 +0800"},{"status":["M"],"files":["\"2021-03-27 \\345\\210\\206\\345\\270\\203\\345\\274\\217\\344\\272\\213\\345\\212\\241.md\""],"abbrevHash":"2350275","hash":"23502753115b471460e6fd02ef11c0181de95f4b","subject":"Update 2021-03-27 分布式事务.md","authorName":"yajw","authorDate":"2021-04-26 11:47:25 +0800"},{"status":["A"],"files":["\"2021-03-27 \\345\\210\\206\\345\\270\\203\\345\\274\\217\\344\\272\\213\\345\\212\\241.md\""],"abbrevHash":"f4f4061","hash":"f4f406175bde5279c552d8bac1c05cf7bb72d58e","subject":"Copy old posts","authorName":"yajw","authorDate":"2021-03-27 14:49:15 +0800"}],"link":"2021-03-27%20%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1","id":"a7b4f0d7-5ccb-424a-86c0-26cff35318bc","content":"<p>mysql\noceanbase\ntidb\nrocketmq\nmsgBroker</p>\n<p>TCC, XA，事务消息</p>\n<p>本地消息表，执行本地事务，记录要发送某个消息，事务成功后，再由一个调度任务把消息发送出去，并且保证成功（不断重试，业务上要求消费方幂等，失败情况属于系统问题需要人工介入）。关键是调度任务。</p>\n<h2>seata</h2>\n<p><a href=\"https://www.infoq.cn/article/rg0Fs8oIxWdkhZe0p5bW\">逸仙电商 Seata 企业级落地实践</a></p>\n<p>一个最基本的实现：</p>\n<ol>\n<li>通过xid和各个份分支事务串起来整个分布式事务</li>\n<li>为了支持回滚，在本地事务开启后，修改本地事务数据前，查询并记录undolog，持久化下来。在本地事务提交后，整个分布式事务回滚通过undolog来实现</li>\n<li>事务的一致性：默认读为提交，读已提交需要业务加<code>select for update</code>悲观锁，也就是依赖本地事务的方式来实现</li>\n</ol>\n<p>分布式锁的实现：</p>\n<ol>\n<li>mysql通过insert和索引保证正确性(integrity)，加锁insert一条记录，释放锁delete掉</li>\n</ol>\n<p>xid的生成：\n<code>{ip}{port}{uuid}</code></p>\n<p>对AT模式暂时的疑问：</p>\n<ol>\n<li>对acid支持可能非常弱，简单说转账和充值并发的场景，seata的undolog可能做不到一致性</li>\n<li>同时性能也不会很好（事务过程中需要查询并记录undolog），还需要和seata服务端的交互，包括加锁和事务协调</li>\n</ol>\n<p>看了几个相关的github的issue，也大致印证了。</p>\n"}},"__N_SSG":true}