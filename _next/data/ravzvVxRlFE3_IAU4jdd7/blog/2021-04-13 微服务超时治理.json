{"pageProps":{"post":{"tags":["超时"],"categories":["微服务"],"title":" 微服务超时治理","modifyTime":"2021-04-13 18:13:40 +0800","createTime":"2021-04-13 18:14:17 +0800","logs":[{"status":["M"],"files":["\"2021-04-13 \\345\\276\\256\\346\\234\\215\\345\\212\\241\\350\\266\\205\\346\\227\\266\\346\\262\\273\\347\\220\\206.md\""],"abbrevHash":"ff69b48","hash":"ff69b481ec901d53694d91cd6c31ccf99b041c37","subject":"Update 2021-04-13 微服务超时治理.md","authorName":"yajw","authorDate":"2021-04-13 18:14:17 +0800"},{"status":["A"],"files":["\"2021-04-13 \\345\\276\\256\\346\\234\\215\\345\\212\\241\\350\\266\\205\\346\\227\\266\\346\\262\\273\\347\\220\\206.md\""],"abbrevHash":"bd32fef","hash":"bd32fefc0536ce878b894e902924c8ac81a3a4f0","subject":"Create 2021-04-13 微服务超时治理.md","authorName":"yajw","authorDate":"2021-04-13 18:13:40 +0800"}],"link":"2021-04-13%20%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%B6%85%E6%97%B6%E6%B2%BB%E7%90%86","id":"29116b32-4777-4655-b188-ca728c5071df","comments":false,"content":"<p><em>设置超时时间的意义，是在极端情况下，采⽤主动的快速失败策略，使得资源消耗与释放资源之间达到平衡，避免调⽤双⽅因资源耗尽⽽宕机。</em></p>\n<p><em>超时时间的设置，和熔断、限流⼀样，是异常状况下系统的⼀种⾃我保护机制，熔断、限流都已经从业务解耦⾄框架层，如利⽤API ⽹关可以统⼀处理微服务之间调⽤的熔断、限流。</em></p>\n<h1>服务调用超时设置多大</h1>\n<p>几个系统参数：</p>\n<ol>\n<li>40ms：延迟确认和nagle同时打开时，延迟确认超时默认最大40ms，nagle最大200ms</li>\n<li>200ms: rtt比较小的网络环境下，超时重传时间</li>\n<li>1s：新版内核建立连接syn超时时间</li>\n</ol>\n<p>用户角度：越快体验越好，决定了上限，比如2s</p>\n<p>系统角度：决定了下限</p>\n<ol>\n<li>系统参数，超时在200ms以上比较合适（能够允许一次超时重传或者nagle的超时）</li>\n<li>资源角度，资源一定并且每个请求消耗的平均资源一定的架设下，QPS和超时时间成反比，超时越大能够支持的并发越小，通过具体压测寻找</li>\n</ol>\n<p>参考2建议配置300ms到2s之间。</p>\n<h1>动态设置</h1>\n<p>自动配置：</p>\n<ol>\n<li>采集调用耗时和超时率</li>\n<li>分析决定得到最佳的超时参数</li>\n<li>通过配置下发方式配置给应用</li>\n</ol>\n<p>这里如何决定最佳值是一个优化目标，制定业务目标，搞清楚约束条件，动态实时反馈寻找最优解的过程。简单的决定方法例如P99.9，动态反馈+最优化方法等。</p>\n<p>调用链递减：\n例如A->B->C的调用链，A的超时是200ms，分配给B和C的和要不超过200ms。具体实现需要依赖底层的服务调用框架。</p>\n<h1>其他</h1>\n<p>参考1中提到了TCP的Linger选项：</p>\n<ol>\n<li>jedis默认开启这个选项，在服务端发送fin后，会返回服务端RESET，以快速关闭连接。</li>\n</ol>\n<h1>参考</h1>\n<ol>\n<li><a href=\"https://zhuanlan.zhihu.com/p/65686330\">处理网络超时问题的最佳实践</a></li>\n<li><a href=\"https://www.infoq.cn/article/eyrSLAr53L6HJm5YJgyX\">微服务之间调用超时的设置治理</a></li>\n<li><a href=\"https://help.aliyun.com/document_detail/190106.html\">微服务引擎MSE > 微服务治理 > Dubbo服务治理 > 动态配置超时</a></li>\n</ol>\n"}},"__N_SSG":true}