{"pageProps":{"post":{"title":" pysftp 踩坑记","comments":true,"date":"2020-02-13T00:00:00.000Z","tags":["sftp","踩坑","网络"],"categories":["实践"],"modifyTime":"2021-03-27 14:49:15 +0800","createTime":"2021-03-27 14:49:15 +0800","logs":[{"status":["A"],"files":["\"2021-03-27 pysftp \\350\\270\\251\\345\\235\\221\\350\\256\\260.md\""],"abbrevHash":"f4f4061","hash":"f4f406175bde5279c552d8bac1c05cf7bb72d58e","subject":"Copy old posts","authorName":"yajw","authorDate":"2021-03-27 14:49:15 +0800"}],"link":"2021-03-27%20pysftp%20%E8%B8%A9%E5%9D%91%E8%AE%B0","id":"408d3e89-7782-4c29-9179-61441ee7a4ea","content":"<p>出错客户端代码：</p>\n<pre><code class=\"language-python\">with pysftp.Connection(host, port, username, password, cnopts) as sftp:\n    # upload a 10M size file to sftp server\n    return True\n</code></pre>\n<p><code>return True</code>这一行抛错：</p>\n<pre><code>File \"/usr/lib/python2.7/contextlib.py\", line 35, in __exit__ self.gen.throw(type, value, traceback)\nFile \"/usr/local/lib/python2.7/dist-packages/pysftp/__init__.py\", line 511, in cd self.cwd(original_path)\nFile \"/usr/local/lib/python2.7/dist-packages/pysftp/__init__.py\", line 524, in chdir self._sftp.chdir(remotepath)\nFile \"/usr/local/lib/python2.7/dist-packages/paramiko/sftp_client.py\", line 659, in chdir if not stat.S_ISDIR(self.stat(path).st_mode):\nFile \"/usr/local/lib/python2.7/dist-packages/paramiko/sftp_client.py\", line 493, in stat t, msg = self._request(CMD_STAT, path)\nFile \"/usr/local/lib/python2.7/dist-packages/paramiko/sftp_client.py\", line 812, in _request num = self._async_request(type(None), t, *arg)\nFile \"/usr/local/lib/python2.7/dist-packages/paramiko/sftp_client.py\", line 837, in _async_request self._send_packet(t, msg)\nFile \"/usr/local/lib/python2.7/dist-packages/paramiko/sftp.py\", line 198, in _send_packet self._write_all(out)\nFile \"/usr/local/lib/python2.7/dist-packages/paramiko/sftp.py\", line 162, in _write_all n = self.sock.send(out)\nFile \"/usr/local/lib/python2.7/dist-packages/paramiko/channel.py\", line 801, in send return self._send(s, m)\nFile \"/usr/local/lib/python2.7/dist-packages/paramiko/channel.py\", line 1180, in _send raise socket.error(\"Socket is closed\")\nerror: Socket is closed\n</code></pre>\n<p>找到这几个有用的链接</p>\n<ol>\n<li>https://www.cnblogs.com/Vooom/p/5820644.html\n这篇说的是使用paramiko连接ssh时，可以通过ssh_client.invoke_shell()来keep alive</li>\n<li>https://gaomf.cn/2017/01/10/SSH_Broken_Pipe/\n这篇说的是ssh连接可以分别通过客户端和服务端两个参数的配置实现连接keep alive</li>\n<li>http://docs.paramiko.org/en/latest/api/transport.html#paramiko.transport.Transport.set_keepalive\n这是paramiko的官方文档中提到的客户端设置keepalive的配置</li>\n<li>https://programtalk.com/python-examples/pysftp.Connection/\n这篇提到pysftp可以通过sftp_connection._transport获得对应的paramiko连接，然后通过set_keepalive来设置</li>\n</ol>\n"}},"__N_SSG":true}