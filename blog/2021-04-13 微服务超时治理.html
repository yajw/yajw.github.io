<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>blog -  微服务超时治理</title><link rel="icon" href="/favicon.ico"/><link rel="stylesheet" href="/static/css/androidstudio.min.css"/><script src="/static/js/highlight.min.js"></script><script>hljs.highlightAll();</script><meta name="next-head-count" content="7"/><link rel="preload" href="/_next/static/css/3c5946e20da2cc20d075.css" as="style"/><link rel="stylesheet" href="/_next/static/css/3c5946e20da2cc20d075.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e2e6dc732d39303ab748.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e2e6dc732d39303ab748.css" data-n-p=""/><link rel="preload" href="/_next/static/css/4b5ef9ffeb729d4f1c31.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4b5ef9ffeb729d4f1c31.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-c006ee6087559bbd65e3.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.15878d4e523f86636251.js" as="script"/><link rel="preload" href="/_next/static/chunks/99f422a92ff7083adb8a7d840734144fa7589f68.e37cca09058b1656d546.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-86af5e0fcdd51c9c3a66.js" as="script"/><link rel="preload" href="/_next/static/chunks/314642ff.81d3755a1df95fed9f2f.js" as="script"/><link rel="preload" href="/_next/static/chunks/762e22088df2ca7ea97d3f731b2a7315c482f91e.cb9acb13aef2b3683e00.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/%5Blink%5D-87cd50cf458654f0c030.js" as="script"/></head><body><div id="__next"><div class="Home_container__1EcsU"><main class="Home_main__1x8gC"><div class="ui text container"><h1 class="ui header"> 微服务超时治理</h1><span></span><section><p><em>设置超时时间的意义，是在极端情况下，采⽤主动的快速失败策略，使得资源消耗与释放资源之间达到平衡，避免调⽤双⽅因资源耗尽⽽宕机。</em></p>
<p><em>超时时间的设置，和熔断、限流⼀样，是异常状况下系统的⼀种⾃我保护机制，熔断、限流都已经从业务解耦⾄框架层，如利⽤API ⽹关可以统⼀处理微服务之间调⽤的熔断、限流。</em></p>
<h1>服务调用超时设置多大</h1>
<p>几个系统参数：</p>
<ol>
<li>40ms：延迟确认和nagle同时打开时，延迟确认超时默认最大40ms，nagle最大200ms</li>
<li>200ms: rtt比较小的网络环境下，超时重传时间</li>
<li>1s：新版内核建立连接syn超时时间</li>
</ol>
<p>用户角度：越快体验越好，决定了上限，比如2s</p>
<p>系统角度：决定了下限</p>
<ol>
<li>系统参数，超时在200ms以上比较合适（能够允许一次超时重传或者nagle的超时）</li>
<li>资源角度，资源一定并且每个请求消耗的平均资源一定的架设下，QPS和超时时间成反比，超时越大能够支持的并发越小，通过具体压测寻找</li>
</ol>
<p>参考2建议配置300ms到2s之间。</p>
<h1>动态设置</h1>
<p>自动配置：</p>
<ol>
<li>采集调用耗时和超时率</li>
<li>分析决定得到最佳的超时参数</li>
<li>通过配置下发方式配置给应用</li>
</ol>
<p>这里如何决定最佳值是一个优化目标，制定业务目标，搞清楚约束条件，动态实时反馈寻找最优解的过程。简单的决定方法例如P99.9，动态反馈+最优化方法等。</p>
<p>调用链递减：
例如A->B->C的调用链，A的超时是200ms，分配给B和C的和要不超过200ms。具体实现需要依赖底层的服务调用框架。</p>
<h1>其他</h1>
<p>参考1中提到了TCP的Linger选项：</p>
<ol>
<li>jedis默认开启这个选项，在服务端发送fin后，会返回服务端RESET，以快速关闭连接。</li>
</ol>
<h1>参考</h1>
<ol>
<li><a href="https://zhuanlan.zhihu.com/p/65686330">处理网络超时问题的最佳实践</a></li>
<li><a href="https://www.infoq.cn/article/eyrSLAr53L6HJm5YJgyX">微服务之间调用超时的设置治理</a></li>
<li><a href="https://help.aliyun.com/document_detail/190106.html">微服务引擎MSE > 微服务治理 > Dubbo服务治理 > 动态配置超时</a></li>
</ol>
</section><div role="list" class="ui list"><div role="listitem" class="item">2021-04-13 18:14:17 +0800<!-- --> <!-- -->yajw<!-- --> <!-- -->Update 2021-04-13 微服务超时治理.md<!-- --> <!-- -->M</div><div role="listitem" class="item">2021-04-13 18:13:40 +0800<!-- --> <!-- -->yajw<!-- --> <!-- -->Create 2021-04-13 微服务超时治理.md<!-- --> <!-- -->A</div></div><div id="comments"></div></div></main><footer class="Home_footer__1WdhD"><div class="Home_powered__2GdUA">Powered by<!-- --> <a href="https://nextjs.org/" target="_blank" rel="noopener noreferrer">Next.js</a>.</div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"tags":["超时"],"categories":["微服务"],"title":" 微服务超时治理","modifyTime":"2021-04-13 18:13:40 +0800","createTime":"2021-04-13 18:14:17 +0800","logs":[{"status":["M"],"files":["\"2021-04-13 \\345\\276\\256\\346\\234\\215\\345\\212\\241\\350\\266\\205\\346\\227\\266\\346\\262\\273\\347\\220\\206.md\""],"abbrevHash":"ff69b48","hash":"ff69b481ec901d53694d91cd6c31ccf99b041c37","subject":"Update 2021-04-13 微服务超时治理.md","authorName":"yajw","authorDate":"2021-04-13 18:14:17 +0800"},{"status":["A"],"files":["\"2021-04-13 \\345\\276\\256\\346\\234\\215\\345\\212\\241\\350\\266\\205\\346\\227\\266\\346\\262\\273\\347\\220\\206.md\""],"abbrevHash":"bd32fef","hash":"bd32fefc0536ce878b894e902924c8ac81a3a4f0","subject":"Create 2021-04-13 微服务超时治理.md","authorName":"yajw","authorDate":"2021-04-13 18:13:40 +0800"}],"link":"2021-04-13%20%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%B6%85%E6%97%B6%E6%B2%BB%E7%90%86","id":"29116b32-4777-4655-b188-ca728c5071df","comments":false,"content":"\u003cp\u003e\u003cem\u003e设置超时时间的意义，是在极端情况下，采⽤主动的快速失败策略，使得资源消耗与释放资源之间达到平衡，避免调⽤双⽅因资源耗尽⽽宕机。\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e超时时间的设置，和熔断、限流⼀样，是异常状况下系统的⼀种⾃我保护机制，熔断、限流都已经从业务解耦⾄框架层，如利⽤API ⽹关可以统⼀处理微服务之间调⽤的熔断、限流。\u003c/em\u003e\u003c/p\u003e\n\u003ch1\u003e服务调用超时设置多大\u003c/h1\u003e\n\u003cp\u003e几个系统参数：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e40ms：延迟确认和nagle同时打开时，延迟确认超时默认最大40ms，nagle最大200ms\u003c/li\u003e\n\u003cli\u003e200ms: rtt比较小的网络环境下，超时重传时间\u003c/li\u003e\n\u003cli\u003e1s：新版内核建立连接syn超时时间\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e用户角度：越快体验越好，决定了上限，比如2s\u003c/p\u003e\n\u003cp\u003e系统角度：决定了下限\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e系统参数，超时在200ms以上比较合适（能够允许一次超时重传或者nagle的超时）\u003c/li\u003e\n\u003cli\u003e资源角度，资源一定并且每个请求消耗的平均资源一定的架设下，QPS和超时时间成反比，超时越大能够支持的并发越小，通过具体压测寻找\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e参考2建议配置300ms到2s之间。\u003c/p\u003e\n\u003ch1\u003e动态设置\u003c/h1\u003e\n\u003cp\u003e自动配置：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e采集调用耗时和超时率\u003c/li\u003e\n\u003cli\u003e分析决定得到最佳的超时参数\u003c/li\u003e\n\u003cli\u003e通过配置下发方式配置给应用\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e这里如何决定最佳值是一个优化目标，制定业务目标，搞清楚约束条件，动态实时反馈寻找最优解的过程。简单的决定方法例如P99.9，动态反馈+最优化方法等。\u003c/p\u003e\n\u003cp\u003e调用链递减：\n例如A-\u003eB-\u003eC的调用链，A的超时是200ms，分配给B和C的和要不超过200ms。具体实现需要依赖底层的服务调用框架。\u003c/p\u003e\n\u003ch1\u003e其他\u003c/h1\u003e\n\u003cp\u003e参考1中提到了TCP的Linger选项：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003ejedis默认开启这个选项，在服务端发送fin后，会返回服务端RESET，以快速关闭连接。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch1\u003e参考\u003c/h1\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"https://zhuanlan.zhihu.com/p/65686330\"\u003e处理网络超时问题的最佳实践\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.infoq.cn/article/eyrSLAr53L6HJm5YJgyX\"\u003e微服务之间调用超时的设置治理\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://help.aliyun.com/document_detail/190106.html\"\u003e微服务引擎MSE \u003e 微服务治理 \u003e Dubbo服务治理 \u003e 动态配置超时\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n"}},"__N_SSG":true},"page":"/blog/[link]","query":{"link":"2021-04-13 微服务超时治理"},"buildId":"ravzvVxRlFE3_IAU4jdd7","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-ff94e68042added27a93.js"></script><script src="/_next/static/chunks/main-c006ee6087559bbd65e3.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.15878d4e523f86636251.js" async=""></script><script src="/_next/static/chunks/99f422a92ff7083adb8a7d840734144fa7589f68.e37cca09058b1656d546.js" async=""></script><script src="/_next/static/chunks/pages/_app-86af5e0fcdd51c9c3a66.js" async=""></script><script src="/_next/static/chunks/314642ff.81d3755a1df95fed9f2f.js" async=""></script><script src="/_next/static/chunks/762e22088df2ca7ea97d3f731b2a7315c482f91e.cb9acb13aef2b3683e00.js" async=""></script><script src="/_next/static/chunks/pages/blog/%5Blink%5D-87cd50cf458654f0c030.js" async=""></script><script src="/_next/static/ravzvVxRlFE3_IAU4jdd7/_buildManifest.js" async=""></script><script src="/_next/static/ravzvVxRlFE3_IAU4jdd7/_ssgManifest.js" async=""></script></body></html>